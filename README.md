# Инструкция MTS DaC

Расширенная поддержка PlantUML для Visual Studio Code (форк https://github.com/qjebbs/vscode-plantuml).

## Уведомление

Теперь настоятельно рекомендуется использовать серверный рендеринг в этом расширении, так как он значительно быстрее и проще в настройке, в то время как основные недостатки были улучшены:

- Включен метод POST, теперь вы можете рендерить очень большие диаграммы.
- В расширении появился новый процессор включений, вам больше не придется сталкиваться с проблемами включения.

Чтобы убедиться, что вы можете воспользоваться этим обновлением, убедитесь, что ваш сервер plantuml поддерживает метод POST.

Если нет, как официальный <https://www.plantuml.com/plantuml>, расширение переключается на использование GET, и вы все еще можете столкнуться с ошибками 414 URI Too Long. Рекомендуется настроить свой собственный сервер.

[Смотрите также: О рендеринге](#about-render)


## Особенности

- Предпросмотр диаграммы, нажмите <kbd>Alt</kbd> + <kbd>D</kbd>, чтобы начать предпросмотр PlantUML (<kbd>option</kbd> + <kbd>D</kbd> на MacOS).
    - Автообновление.
    - Поддержка масштабирования и прокрутки.
    - Поддержка многостраничных диаграмм.
    - Мгновенный предпросмотр, если диаграмма была экспортирована.
    - Локально или с сервера.
    - Привязка к границе.
- Экспорт диаграмм
    - У курсора, в текущем файле, во всем рабочем пространстве, выбранном в рабочем пространстве.
    - Одновременный экспорт.
    - Генерация URL.
    - Поддержка многостраничных диаграмм.
    - Локально или с сервера.
    - Поддержка карты изображения (cmapx).
- Поддержка редактирования
    - Форматирование кода PlantUML. (Устарело)
    - Подсветка синтаксиса всех типов.
    - Сниппеты всех типов.
    - Базовая автодополнение & поддержка макросов.
    - Поддержка списка символов.
- Прочее
    - Поддержка многокорневого рабочего пространства.
    - Интеграция с MarkDown. [Посмотреть демо](#markdown-integrating)
    - Поддержка извлечения исходного кода из изображений.

> Внимание: Если вы используете настраиваемый plantuml.jar, пожалуйста, обновите его до последней версии, чтобы включить поддержку многостраничных диаграмм. (Позднее V1.2017.15)

> Форматирование кода PlantUML устарело. Не полагайтесь на это, используйте только когда это работает правильно. Я принудительно отключил это в случаях автоформатирования (форматирование при сохранении).

## Поддерживаемые форматы

*.wsd, *.pu, *.puml, *.plantuml, *.iuml

## Как установить

Запустите Быстрое открытие в VS Code (Ctrl+P), вставьте следующую команду и нажмите Enter.

ext install plantuml

## Требования

В зависимости от выбранного вами рендеринга, плагин имеет разные требования.

### Требования для рендеринга на PlantUMLServer

Сервер plantuml. Смотрите [Использование PlantUML Server в качестве рендера](#use-plantuml-server-as-render).

### Требования для локального рендеринга

Необходимо иметь установленные следующие компоненты:

- [Java][Java] : Платформа для работы PlantUML.
- [Graphviz][Graphviz] : PlantUML требует его для расчета позиций на диаграмме.

[Java]: http://java.com/en/download/ "Скачать Java"
[Graphviz]: http://www.graphviz.org/download/ "Скачать Graphviz"

#### Быстрая установка для Mac

sh
brew install --cask temurin
brew install graphviz

#### Быстрая установка для Windows

Плагин имеет встроенную копию plantuml.jar и GraphViz, так что обычно у вас все должно работать. 
Но если вы хотите использовать свой собственный jar или другую версию GraphViz (возможно, более новую или с множеством зависимых jar):

- скачать последнюю версию plantuml.jar или установить ее с помощью chocolatey (смотрите ниже).
- указать расположение jar с помощью настройки расширения plantuml.jar.
- указать установку GraphViz, определив переменную среды Windows GRAPHVIZ_DOT, например, c:\program files\graphviz\bin\dot.exe если вы установили plantuml с помощью chocolatey, которая автоматически устанавливает последнюю версию GraphViz в качестве зависимости.

##### Установка через Choco
Для пользователей Windows majkinetor (https://github.com/majkinetor) предложил способ легко установить plantuml и его зависимости.
Запустите cmd.exe от имени администратора и выполните две команды, как показано ниже (первая команда не нужна и завершится с ошибкой, если у вас уже установлен chocolatey).

cmd
@"%SystemRoot%\System32\WindowsPowerShell\v1.0\powershell.exe" -NoProfile -ExecutionPolicy Bypass -Command "iex ((New-Object System.Net.WebClient).DownloadString('https://chocolatey.org/install.ps1'))" && SET "PATH=%PATH%;%ALLUSERSPROFILE%\chocolatey\bin"

> Если вы установили Java, но все еще появляется сообщение "Java не установлена", пожалуйста, добавьте путь к папке bin Java в переменную среды PATH.

## Типичная Организация Файлов

- Стандартные настройки расширения работают для независимых проектов Plantuml.
- Если файлы Plantuml являются лишь частью вашего проекта (как документация), используйте plantuml.diagramsRoot и plantuml.exportOutDir для настройки организации, например:

json
"plantuml.diagramsRoot": "docs/diagrams/src",
"plantuml.exportOutDir": "docs/diagrams/out"

Вы получите результаты экспорта вроде:

Папка проекта/
  docs/
    diagrams/
      src/
        architectureoverview.wsd
      out/
        architectureoverview/
          architectureoverview.png
  ...остальныепапкивашегопроекта/
  ...остальныефайлывашегопроекта 

## Логика Поиска Файлов Include

В последней версии логика поиска файлов include снова изменилась.
Теперь можно настроить includepaths в settings.json.

Новый порядок поиска следующий:
1. Папка рендеринга файла
2. Пути includepaths, настроенные в settings.json
json
"plantuml.includepaths": ["docs/diagrams/style","docs/diagrams/src"],
3. diagramsRoot

Настройка includeSearch больше не нужна, так как папка файла plantuml и diagramsRoot всегда оба включены в путь поиска.

Для новых проектов рекомендуется не полагаться на diagramsRoot и явно настроить все необходимые includepaths.

> Спасибо [anotherandi](https://github.com/anotherandi) за блестящую идею и реализацию!

## Демонстрации Предпросмотра

Страница предпросмотра предлагает различные действия масштабирования/перетаскивания и функцию привязки:

- Операции масштабирования (с версии 2.7.0): 
    - Масштабирование для выбранной области
    - Щипок для масштабирования (TouchPad)
    - Клик для увеличения, alt + клик для уменьшения
    - Ctrl + прокрутка мыши для увеличения/уменьшения
    - Клик средней кнопкой мыши для переключения масштаба
    - Кнопки увеличения/уменьшения/переключения масштаба на панели управления.
- Операции перемещения (с версии 2.7.0):
    - Перетаскивание правой кнопкой мыши
    - Движение двумя пальцами для панорамирования (TouchPad)
    - Прокрутка мыши
- Привязка к границе (с v2.8.0):
    - Прокрутка до самой нижней/правой/верхней/левой границы, предпросмотр будет привязан к этой границе. 
    > Например, привязка к низу полезна при написании длинных диаграмм активности, что помогает вам сосредоточиться на последней части внизу.  


Автообновление:

![демонстрация автообновления](images/autoupdatedemo.gif)

масштабирование и прокрутка:

![демонстрация масштабирования](images/zoomdemo.gif)

Многостраничный Просмотр:

!демонстрация многостраничного просмотра

## Демонстрации Экспорта

Экспорт диаграммы:

!демонстрация экспорта

## Генерация URL

!демонстрация URL

## Извлечение Исходного Кода Диаграммы

!демонстрация извлечения

## О Форматировании

!демонстрация форматирования

> Форматировщик PlantUML отключен (с версии v2.8.3), если включено editor.formatOnSave. 
Потому что форматировщик не достаточно надежен согласно отзывам пользователей.

## О Сниппетах

!демонстрация сниппетов

Этот плагин интегрирует сниппеты всех типов диаграмм. Они разделены на 9 секций:

- diagram: сниппеты для общих элементов диаграмм.
- activity: сниппеты для диаграмм активности.
- class: сниппеты для классовых диаграмм.
- component: сниппеты для диаграмм компонентов.
- state: сниппеты для диаграмм состояний.
- usecase: сниппеты для диаграмм вариантов использования.
- sequence: сниппеты для последовательностных диаграмм.
- ui: сниппеты для диаграмм salt.
- egg: сниппеты для некоторых забавных диаграмм, как судоку, земля.

Например, напишите acife (короткая версия), чтобы вызвать следующий сниппет (activity➤if・else):

plantumlcode
if (cond1?) then (val1)

else (val2)

endif

## О Списке Символов (Список диаграмм файла)

!list_symbol_demo.png

Нажмите Ctrl+Shift+O, чтобы показать все диаграммы в файле. Вы можете дать имя диаграмме при ее начале.

> @startuml имя диаграммы
> sudoku
> @enduml

## О Рендеринге

Плагин поддерживает два типа рендеринга: Local и PlantUMLServer.

Local - это стандартный и традиционный способ. Если вы больше заботитесь о скорости экспорта, вам следует попробовать PlantUMLServer.

Локальный: 6 документов, 9 диаграмм, 14 файлов экспортировано за 24.149 секунд
PlantUMLServer: 6 документов, 9 диаграмм, 14 файлов экспортировано за 1.564 секунды

## Преимущества и недостатки рендеринга PlantUMLServer

Преимущества:

- Экспорт быстрее примерно в 15 раз и более быстрый отклик при предварительном просмотре.
- Не нужно устанавливать локальные среды, если у вас есть сервер в команде.
- Вам не нужно plantuml.exportConcurrency, потому что конкуренция не ограничена.

Недостатки:

- Не может рендерить очень большие диаграммы (414 URI Too Long).
- Не может рендерить диаграммы с !include в них.
- Меньше поддерживаемых форматов: png, svg, txt.
- Некоторые настройки не применимы: plantuml.jar, plantuml.commandArgs, plantuml.jarArgs.

## Использование PlantUML Server как рендера


> Чтобы рендерить очень большие диаграммы с поддержкой include, убедитесь, что ваш сервер plantuml поддерживает POST.
>
> Если нет, как официальный <https://www.plantuml.com/plantuml>, расширение переключается на использование GET, и вы все еще можете столкнуться с ошибками 414 URI Too Long.
>
> Рекомендуется настроить свой собственный сервер.

- Возможно, у вашей команды уже есть сервер PlantUML, найдите адрес сервера, например: http://192.168.1.100:8080.

- Если у вас его нет, настройте согласно инструкциям (https://github.com/plantuml/plantuml-server), рекомендуется запускать с Docker. Найдите адрес сервера, например: http://localhost:8080 или http://192.168.1.100:8080, который готов к использованию вашей командой.

- Другой вариант запуска сервера PlantUML на вашем локальном компьютере - использовать встроенный picowebserver, который может быть таким же простым, как выполнение команды java -jar plantuml.jar -picoweb, подробнее читайте здесь: <https://plantuml.com/picoweb>

- Откройте настройки пользователя и настройте так:

text
"plantuml.server": "http://192.168.1.100:8080",
"plantuml.render": "PlantUMLServer",

## Поддержка многоязычности

Переводы приветствуются. lang.nls.json (https://github.com/qjebbs/vscode-plantuml/blob/master/langs/lang.nls.json), package.nls.json (https://github.com/qjebbs/vscode-plantuml/blob/master/package.nls.json)

!демонстрация языков

## Интеграция с MarkDown

!демонстрация markdown

Все еще рекомендуется использовать @startuml / @enduml, чтобы код PlantUML в Markdown мог управляться другими функциями этого плагина.

## Настройки Расширения

Это расширение вносит следующие настройки.

Выбор рендера:

- plantuml.render: Выбор рендера диаграмм для экспорта и предварительного просмотра.

Настройки рендера PlantUMLServer:

- plantuml.server: Сервер PlantUML для создания UML диаграмм на лету.

Настройки локального рендера:

- plantuml.java: Расположение исполняемого файла Java.
- plantuml.commandArgs: commandArgs позволяет добавлять аргументы командной строки к команде java, такие как -DPLANTUMLLIMITSIZE=8192.
- plantuml.jar: Альтернативное расположение plantuml.jar. Оставьте пустым, чтобы использовать интегрированный jar.
- plantuml.jarArgs: jarArgs позволяет добавлять аргументы к plantuml.jar, такие как -config plantuml.config.
- plantuml.includepaths: Указывает пути включения помимо исходной папки и diagramsRoot.

Настройки экспорта:

- plantuml.diagramsRoot: Указывает, где расположены все файлы диаграмм (относительно папки рабочего пространства).
- plantuml.exportOutDir: Экспортируемые диаграммы рабочего пространства будут организованы в этой директории (относительный путь к папке рабочего пространства).
- plantuml.fileExtensions: Расширения файлов для поиска экспортируемых диаграмм. Особенно в настройках рабочего пространства вы можете добавить свои расширения, чтобы экспортировать диаграммы из исходных кодов файлов, таких как ".java".
- plantuml.exportFormat: формат для экспорта. По умолчанию не установлен, пользователь может выбрать один формат каждый раз при экспорте. Вы все еще можете установить формат, если не хотите выбирать.
- plantuml.exportSubFolder: экспорт диаграмм в папку с тем же именем, что и у основного файла.
- plantuml.exportIncludeFolderHeirarchy: включение иерархии папок между корнем и исходной диаграммой в путь экспортированного файла.
- plantuml.exportConcurrency: определяет количество одновременных операций при экспорте нескольких диаграмм.
- plantuml.exportMapFile: определяет, следует ли экспортировать файл карты изображений (.cmapx) при экспорте

Настройки превью:

- plantuml.previewAutoUpdate: Определяет, будет ли автоматически обновляться окно предварительного просмотра.

Другие Настройки:

- plantuml.urlFormat: Формат URL. Оставьте пустым, чтобы выбирать формат каждый раз, когда вы генерируете URL.
- plantuml.urlResult: Тип результата URL. Простой URL или готов к использованию в MarkDown.
- plantuml.lintDiagramNoName: Определяет, следует ли выполнять проверку на ошибки, когда у диаграммы нет имени.